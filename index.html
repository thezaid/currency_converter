<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Converter</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Simple spinner for loading state */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #fff;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Custom scrollbar for history */
        #history-container::-webkit-scrollbar {
            width: 6px;
        }
        #history-container::-webkit-scrollbar-track {
            background: transparent;
        }
        #history-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        #history-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body class="h-full bg-gray-900 flex items-center justify-center font-sans p-4">

    <div class="max-w-md w-full bg-white/10 backdrop-blur-lg text-white rounded-2xl shadow-2xl p-6 sm:p-8">
        
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-4">
            Currency Converter
        </h1>

        <!-- Rate display -->
        <div id="rate-display" class="flex items-center justify-center space-x-2 text-lg text-gray-300 mb-6 h-6">
            <!-- Loading spinner -->
            <div class="spinner"></div>
            <span>Loading latest rate...</span>
        </div>

        <div class="space-y-6">
            <!-- AED Input -->
            <div>
                <label for="aed" class="block text-sm font-medium text-gray-200 mb-2">
                    ðŸ‡¦ðŸ‡ª AED (Dirham)
                </label>
                <input type="number" id="aed-input" name="aed" 
                       placeholder="Enter amount in AED"
                       class="block w-full bg-white/5 border border-white/20 rounded-lg p-3 text-white text-lg placeholder-gray-400
                              focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all duration-200"
                       aria-label="AED amount">
            </div>

            <!-- INR Input -->
            <div>
                <label for="inr" class="block text-sm font-medium text-gray-200 mb-2">
                    ðŸ‡®ðŸ‡³ INR (Rupee)
                </label>
                <input type="number" id="inr-input" name="inr" 
                       placeholder="Enter amount in INR"
                       class="block w-full bg-white/5 border border-white/20 rounded-lg p-3 text-white text-lg placeholder-gray-400
                              focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all duration-200"
                       aria-label="INR amount">
            </div>
        </div>
        
        <!-- Controls: Decimal, Clear, Clear History -->
        <div class="flex justify-center items-center space-x-4 mt-6"> 
            <button id="decimal-toggle-button" title="Switch to two decimals"
                    class="text-gray-500 hover:text-cyan-400 transition-colors duration-200 rounded-full p-2
                           focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-opacity-50">
                <!-- Inline SVG "calculator" icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 14h.01M12 17h.01M15 17h.01M9 10h.01M12 10h.01M15 10h.01M6 21h12a2 2 0 002-2V5a2 2 0 00-2-2H6a2 2 0 00-2 2v14a2 2 0 002 2z" />
                </svg>
            </button>

            <button id="clear-button" title="Clear inputs"
                    class="text-gray-500 hover:text-cyan-400 transition-colors duration-200 rounded-full p-2
                           focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-opacity-50">
                <!-- Inline SVG "X" in a circle icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
            
            <button id="clear-history-button" title="Clear history"
                    class="text-gray-500 hover:text-red-400 transition-colors duration-200 rounded-full p-2
                           focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-50">
                <!-- Inline SVG "trash" icon -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </div>

        <!-- History Section -->
        <div id="history-section" class="mt-8 border-t border-white/10 pt-4" style="display: none;"> <!-- Hidden by default -->
             <h2 class="text-lg font-semibold text-center mb-3">
                History
            </h2>
            <div id="history-container" class="max-h-40 overflow-y-auto space-y-2 pr-2">
                <!-- History items will be injected here -->
                <p id="history-placeholder" class="text-sm text-gray-500 text-center">No history yet.</p>
            </div>
        </div>

        <p id="update-status" class="text-xs text-gray-500 text-center mt-6"> <!-- Adjusted margin-top -->
            Rates are fetched live.
        </p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const aedInput = document.getElementById('aed-input');
            const inrInput = document.getElementById('inr-input');
            const rateDisplay = document.getElementById('rate-display');
            const clearButton = document.getElementById('clear-button');
            const decimalToggleButton = document.getElementById('decimal-toggle-button');
            const updateStatus = document.getElementById('update-status');
            const historySection = document.getElementById('history-section');
            const historyContainer = document.getElementById('history-container');
            const historyPlaceholder = document.getElementById('history-placeholder');
            const clearHistoryButton = document.getElementById('clear-history-button');

            let exchangeRate;
            let lastFetchedTime;
            let isAedToInr = true; 
            let showDecimals = false; 
            let history = []; // Array to hold history objects

            const API_URL = 'https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/aed.json';
            const STORAGE_KEYS = {
                RATE: 'currencyConverterRate',
                TIMESTAMP: 'currencyConverterTimestamp',
                HISTORY: 'currencyConverterHistory' // Key for history
            };
            
            // --- History Functions ---

            // 1. Render the history list in the DOM
            function renderHistory() {
                // Clear current list
                historyContainer.innerHTML = ''; 

                if (history.length === 0) {
                    historyContainer.appendChild(historyPlaceholder); // Show placeholder
                    historySection.style.display = 'none'; // Hide section if empty
                } else {
                    historySection.style.display = 'block'; // Show section
                    
                    history.forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'flex justify-between items-center bg-white/5 p-2 rounded-lg text-sm transition-all duration-200';
                        
                        const conversionText = `ðŸ‡¦ðŸ‡ª ${item.aed} &rarr; ðŸ‡®ðŸ‡³ ${item.inr}`;
                        const time = new Date(item.timestamp);
                        const formattedTime = time.toLocaleTimeString('en-US', {
                            hour: 'numeric', minute: '2-digit'
                        });

                        historyItem.innerHTML = `
                            <span class="text-gray-200 font-medium">${conversionText}</span>
                            <span class="text-xs text-gray-500">${formattedTime}</span>
                        `;
                        historyContainer.appendChild(historyItem);
                    });
                }
            }

            // 2. Save the history array to localStorage
            function saveHistory() {
                localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(history));
            }

            // 3. Load history from localStorage
            function loadHistory() {
                const storedHistory = localStorage.getItem(STORAGE_KEYS.HISTORY);
                if (storedHistory) {
                    history = JSON.parse(storedHistory);
                }
                renderHistory(); // Render whatever we loaded
            }

            // 4. Add a new item to history
            function addHistoryItem() {
                const aedVal = aedInput.value;
                const inrVal = inrInput.value;

                // Don't save empty or zero values
                if (!aedVal || !inrVal || parseFloat(aedVal) === 0 || parseFloat(inrVal) === 0) {
                    return;
                }

                // Don't save if it's identical to the most recent entry
                const latest = history[0];
                if (latest && latest.aed === aedVal && latest.inr === inrVal) {
                    return;
                }

                // Add to the beginning of the array
                history.unshift({
                    aed: aedVal,
                    inr: inrVal,
                    timestamp: new Date().toISOString()
                });

                // Keep history limited to 10 items
                history = history.slice(0, 10);
                
                saveHistory();
                renderHistory();
            }

            // 5. Clear history
            function clearHistory() {
                history = [];
                saveHistory();
                renderHistory();
            }

            // --- Rate Fetching and Display ---
            
            /**
             * Formats a date object into a relative time string (e.g., "2 minutes ago").
             * @param {Date} date - The date object to format.
             */
            function formatTimeAgo(date) {
                if (!date) return '';
                const now = new Date();
                const seconds = Math.floor((now.getTime() - date.getTime()) / 1000);

                if (seconds < 60) return 'just now';
                
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                
                const days = Math.floor(hours / 24);
                return `${days} day${days > 1 ? 's' : ''} ago`;
            }

            function updateRateDisplay(isOffline = false) {
                if (!exchangeRate) return;

                rateDisplay.innerHTML = `
                    <span class="font-semibold">1 AED = ${exchangeRate.toFixed(4)} INR</span>
                `;

                const relativeTime = formatTimeAgo(lastFetchedTime);

                if (isOffline) {
                    updateStatus.textContent = `Offline. Using rate from ${relativeTime}.`;
                    updateStatus.classList.add('text-yellow-400');
                    updateStatus.classList.remove('text-gray-500');
                } else {
                    updateStatus.textContent = `Rate updated ${relativeTime}.`;
                    updateStatus.classList.remove('text-yellow-400');
                    updateStatus.classList.add('text-gray-500');
                }
            }
            
            function loadFromCache() {
                const cachedRate = localStorage.getItem(STORAGE_KEYS.RATE);
                const cachedTime = localStorage.getItem(STORAGE_KEYS.TIMESTAMP);

                if (cachedRate && cachedTime) {
                    exchangeRate = parseFloat(cachedRate);
                    lastFetchedTime = new Date(cachedTime);
                    updateRateDisplay(true);
                }
            }

            async function fetchExchangeRate() {
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    
                    if (data.aed && data.aed.inr) {
                        exchangeRate = data.aed.inr;
                        lastFetchedTime = new Date(); 
                        
                        localStorage.setItem(STORAGE_KEYS.RATE, exchangeRate);
                        localStorage.setItem(STORAGE_KEYS.TIMESTAMP, lastFetchedTime.toISOString());
                        
                        updateRateDisplay(false); 
                    } else {
                        throw new Error('Could not find INR rate in API response.');
                    }
                } catch (error) {
                    console.error('Error fetching exchange rate:', error);
                    if (exchangeRate) {
                        updateRateDisplay(true); 
                    } else {
                        rateDisplay.textContent = 'Could not load rate.';
                        rateDisplay.classList.add('text-red-400');
                        updateStatus.textContent = 'Please check your connection.';
                    }
                }
            }

            // --- Conversion Functions ---

            function convertAedToInr() {
                if (!exchangeRate || !isAedToInr) return;
                const aedValue = parseFloat(aedInput.value);
                if (isNaN(aedValue) || aedValue === 0) {
                    inrInput.value = '';
                    return;
                }
                const inrValue = aedValue * exchangeRate;
                inrInput.value = showDecimals ? inrValue.toFixed(2) : Math.ceil(inrValue);
            }

            function convertInrToAed() {
                if (!exchangeRate || isAedToInr) return;
                const inrValue = parseFloat(inrInput.value);
                if (isNaN(inrValue) || inrValue === 0) {
                    aedInput.value = '';
                    return;
                }
                const aedValue = inrValue / exchangeRate;
                aedInput.value = aedValue.toFixed(2);
            }

            // --- Event Listeners ---

            aedInput.addEventListener('focus', () => { isAedToInr = true; });
            inrInput.addEventListener('focus', () => { isAedToInr = false; });
            
            aedInput.addEventListener('input', convertAedToInr);
            inrInput.addEventListener('input', convertInrToAed);

            // Save to history on blur (when user clicks away)
            aedInput.addEventListener('blur', addHistoryItem);
            inrInput.addEventListener('blur', addHistoryItem);

            clearButton.addEventListener('click', () => {
                aedInput.value = '';
                inrInput.value = '';
            });

            clearHistoryButton.addEventListener('click', clearHistory);

            decimalToggleButton.addEventListener('click', () => {
                showDecimals = !showDecimals; 
                if (showDecimals) {
                    decimalToggleButton.classList.remove('text-gray-500', 'hover:text-cyan-400');
                    decimalToggleButton.classList.add('text-cyan-400', 'hover:text-cyan-300');
                    decimalToggleButton.title = "Switch to no decimals (round up)";
                } else {
                    decimalToggleButton.classList.remove('text-cyan-400', 'hover:text-cyan-300');
                    decimalToggleButton.classList.add('text-gray-500', 'hover:text-cyan-400');
                    decimalToggleButton.title = "Switch to two decimals";
                }
                if (aedInput.value) {
                    isAedToInr = true; 
                    convertAedToInr();
                }
            });

            // --- Initial Load ---
            loadFromCache();     // Load cached rate instantly
            loadHistory();       // Load saved history
            fetchExchangeRate(); // Try to get fresh data

            // Add an interval to update the relative time every minute
            setInterval(() => {
                if (lastFetchedTime) {
                    // Re-run updateRateDisplay to refresh the 'time ago' string.
                    // We check navigator.onLine to see if we are currently offline.
                    // This updates the status even if the API fetch fails.
                    updateRateDisplay(!navigator.onLine);
                }
            }, 60000); // 60,000 milliseconds = 1 minute
        });
    </script>

</body>
</html>
