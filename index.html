<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Currency Converter</title>
    
    <!-- Add Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Open Sans', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    <style>
        /* Simple spinner for loading state */
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #fff;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Custom scrollbar for history */
        #history-container::-webkit-scrollbar {
            width: 6px;
        }
        #history-container::-webkit-scrollbar-track {
            background: transparent;
        }
        #history-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        #history-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        /* Style for the keypad button press */
        .key-active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.15); /* Made less bright */
        }
    </style>
</head>
<body class="h-full bg-black flex items-center justify-center font-sans p-4"> <!-- Changed bg-gray-900 to bg-black -->

    <!-- Changed bg-white/10 to bg-gray-900 and added a border -->
    <div class="max-w-sm w-full bg-gray-900 border border-gray-800 text-white rounded-2xl shadow-2xl p-4 sm:p-6">
        
        <h1 class="text-xl sm:text-2xl font-bold text-center mb-4">
            Currency Converter
        </h1>

        <!-- Rate display -->
        <div id="rate-display" class="flex items-center justify-center space-x-2 text-base text-gray-300 mb-6 h-6">
            <!-- Loading spinner -->
            <div class="spinner"></div>
            <!-- Updated initial text -->
            <span>Loading rate...</span>
        </div>

        <div class="space-y-6">
            <!-- AED Input -->
            <div>
                <label for="aed" class="block text-sm font-medium text-gray-200 mb-2">
                    ðŸ‡¦ðŸ‡ª AED (Dirham)
                </label>
                <input type="number" id="aed-input" name="aed" 
                       placeholder="Enter amount in AED"
                       class="block w-full bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-base placeholder-gray-400
                              focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all duration-200"
                       aria-label="AED amount" readonly> <!-- Changed bg-white/5 and border-white/20 -->
            </div>

            <!-- INR Input -->
            <div>
                <label for="inr" class="block text-sm font-medium text-gray-200 mb-2">
                    ðŸ‡®ðŸ‡³ INR (Rupee)
                </label>
                <input type="number" id="inr-input" name="inr" 
                       placeholder="Enter amount in INR"
                       class="block w-full bg-gray-800/50 border border-gray-700 rounded-lg p-3 text-base placeholder-gray-400
                              focus:outline-none focus:ring-2 focus:ring-cyan-400 transition-all duration-200"
                       aria-label="INR amount" readonly> <!-- Changed bg-white/5 and border-white/20 -->
            </div>
        </div>
        
        <!-- On-page Keypad -->
        <div id="keypad" class="grid grid-cols-3 gap-2 sm:gap-3 mt-6">
            <!-- Changed bg-white/5 to bg-gray-800/50 and hover:bg-white/10 to hover:bg-gray-700/50 -->
            <button data-key="7" class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 text-lg font-semibold p-3 rounded-lg transition-all duration-150">7</button>
            <button data-key="8" class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 text-lg font-semibold p-3 rounded-lg transition-all duration-150">8</button>
            <button data-key="9" class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 text-lg font-semibold p-3 rounded-lg transition-all duration-150">9</button>
            <button data-key="4" class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 text-lg font-semibold p-3 rounded-lg transition-all duration-150">4</button>
            <button data-key="5" class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 text-lg font-semibold p-3 rounded-lg transition-all duration-150">5</button>
            <button data-key="6" class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 text-lg font-semibold p-3 rounded-lg transition-all duration-150">6</button>
            <button data-key="1" class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 text-lg font-semibold p-3 rounded-lg transition-all duration-150">1</button>
            <button data-key="2" class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 text-lg font-semibold p-3 rounded-lg transition-all duration-150">2</button>
            <button data-key="3" class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 text-lg font-semibold p-3 rounded-lg transition-all duration-150">3</button>
            <button data-key="." class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 text-xl font-semibold p-3 rounded-lg transition-all duration-150">.</button>
            <button data-key="0" class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 text-lg font-semibold p-3 rounded-lg transition-all duration-150">0</button>
            <button data-key="backspace" class="keypad-button bg-gray-800/50 hover:bg-gray-700/50 p-3 rounded-lg transition-all duration-150 flex items-center justify-center">
                <!-- Lucide "delete" (backspace) icon -->
                <i data-lucide="delete" class="h-5 w-5"></i>
            </button>
        </div>

        <!-- Controls: Decimal, Clear, Clear History -->
        <div class="flex justify-center items-center space-x-4 mt-6"> 
            <button id="decimal-toggle-button" title="Switch to two decimals"
                    class="text-gray-500 hover:text-cyan-400 transition-colors duration-200 rounded-full p-2
                           focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-opacity-50">
                <!-- Lucide "calculator" icon -->
                <i data-lucide="calculator" class="h-5 w-5"></i>
            </button>

            <button id="clear-button" title="Clear inputs"
                    class="text-gray-500 hover:text-cyan-400 transition-colors duration-200 rounded-full p-2
                           focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-opacity-50">
                <!-- Lucide "x-circle" icon -->
                <i data-lucide="x-circle" class="h-5 w-5"></i>
            </button>
            
            <button id="clear-history-button" title="Clear history"
                    class="text-gray-500 hover:text-red-400 transition-colors duration-200 rounded-full p-2
                           focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-50">
                <!-- Lucide "trash-2" icon -->
                <i data-lucide="trash-2" class="h-5 w-5"></i>
            </button>

            <!-- NEW "Get Live Rate" Button -->
            <button id="get-rates-button" title="Get live rate"
                    class="text-gray-500 hover:text-cyan-400 transition-colors duration-200 rounded-full p-2
                           focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-opacity-50">
                <!-- Lucide "refresh-cw" icon -->
                <i data-lucide="refresh-cw" class="h-5 w-5"></i>
            </button>
        </div>

        <!-- History Section -->
        <div id="history-section" class="mt-8 border-t border-gray-800 pt-4" style="display: none;"> <!-- Changed border-white/10 to border-gray-800 -->
             <h2 class="text-base font-semibold text-center mb-3">
                History
            </h2>
            <div id="history-container" class="max-h-40 overflow-y-auto space-y-2 pr-2">
                <!-- History items will be injected here -->
                <p id="history-placeholder" class="text-sm text-gray-500 text-center">No history yet.</p>
            </div>
        </div>

        <!-- Updated status text: initially empty, set by JS -->
        <p id="update-status" class="text-xs text-gray-500 text-center mt-6 h-4">
            <!-- Content set by JavaScript -->
        </p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get all elements
            const aedInput = document.getElementById('aed-input');
            const inrInput = document.getElementById('inr-input');
            const rateDisplay = document.getElementById('rate-display');
            const clearButton = document.getElementById('clear-button');
            const decimalToggleButton = document.getElementById('decimal-toggle-button');
            const updateStatus = document.getElementById('update-status');
            const historySection = document.getElementById('history-section');
            const historyContainer = document.getElementById('history-container');
            const historyPlaceholder = document.getElementById('history-placeholder');
            const clearHistoryButton = document.getElementById('clear-history-button');
            const getRatesButton = document.getElementById('get-rates-button'); // Get the new button
            const keypad = document.getElementById('keypad'); // Get the keypad

            // State variables
            let exchangeRate;
            let lastFetchedTime;
            let isAedToInr = true; 
            let showDecimals = false; 
            let history = []; 
            let activeInput = null; // Track the currently focused input

            const API_URL = 'https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/aed.json';
            const STORAGE_KEYS = {
                RATE: 'currencyConverterRate',
                TIMESTAMP: 'currencyConverterTimestamp',
                HISTORY: 'currencyConverterHistory'
            };
            
            // --- History Functions ---

            function renderHistory() {
                historyContainer.innerHTML = ''; 
                if (history.length === 0) {
                    historyContainer.appendChild(historyPlaceholder);
                    historySection.style.display = 'none';
                } else {
                    historySection.style.display = 'block'; 
                    history.forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.className = 'flex justify-between items-center bg-gray-800/50 p-2 rounded-lg text-sm transition-all duration-200'; // Changed bg-white/5
                        const conversionText = `ðŸ‡¦ðŸ‡ª ${item.aed} &rarr; ðŸ‡®ðŸ‡³ ${item.inr}`;
                        const time = new Date(item.timestamp);
                        const formattedTime = time.toLocaleTimeString('en-US', {
                            hour: 'numeric', minute: '2-digit'
                        });
                        historyItem.innerHTML = `
                            <span class="text-gray-200 font-medium">${conversionText}</span>
                            <span class="text-xs text-gray-500">${formattedTime}</span>
                        `;
                        historyContainer.appendChild(historyItem);
                    });
                }
            }

            function saveHistory() {
                localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(history));
            }

            function loadHistory() {
                const storedHistory = localStorage.getItem(STORAGE_KEYS.HISTORY);
                if (storedHistory) {
                    history = JSON.parse(storedHistory);
                }
                renderHistory();
            }

            function addHistoryItem() {
                const aedVal = aedInput.value;
                const inrVal = inrInput.value;
                if (!aedVal || !inrVal || parseFloat(aedVal) === 0 || parseFloat(inrVal) === 0) {
                    return;
                }
                const latest = history[0];
                if (latest && latest.aed === aedVal && latest.inr === inrVal) {
                    return;
                }
                history.unshift({
                    aed: aedVal,
                    inr: inrVal,
                    timestamp: new Date().toISOString()
                });
                history = history.slice(0, 10);
                saveHistory();
                renderHistory();
            }

            function clearHistory() {
                history = [];
                saveHistory();
                renderHistory();
            }

            // --- Rate Fetching and Display ---
            
            function formatTimeAgo(date) {
                if (!date) return '';
                const now = new Date();
                const seconds = Math.floor((now.getTime() - date.getTime()) / 1000);
                if (seconds < 60) return 'just now';
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
                const days = Math.floor(hours / 24);
                return `${days} day${days > 1 ? 's' : ''} ago`;
            }

            function updateRateDisplay(isOffline = false) {
                if (!exchangeRate) return;
                rateDisplay.innerHTML = `
                    <span class="font-semibold">1 AED = ${exchangeRate.toFixed(4)} INR</span>
                `;
                const relativeTime = formatTimeAgo(lastFetchedTime);
                if (isOffline) {
                    updateStatus.textContent = `Offline. Using rate from ${relativeTime}.`;
                    updateStatus.classList.add('text-yellow-400');
                    updateStatus.classList.remove('text-gray-500');
                } else {
                    updateStatus.textContent = `Rate updated ${relativeTime}.`;
                    updateStatus.classList.remove('text-yellow-400');
                    updateStatus.classList.add('text-gray-500');
                }
            }
            
            function loadFromCache() {
                const cachedRate = localStorage.getItem(STORAGE_KEYS.RATE);
                const cachedTime = localStorage.getItem(STORAGE_KEYS.TIMESTAMP);
                if (cachedRate && cachedTime) {
                    exchangeRate = parseFloat(cachedRate);
                    lastFetchedTime = new Date(cachedTime);
                    updateRateDisplay(true); // Display cached rate
                    return true; // Indicate success
                }
                return false; // Indicate failure
            }

            async function fetchExchangeRate() {
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    
                    if (data.aed && data.aed.inr) {
                        exchangeRate = data.aed.inr;
                        lastFetchedTime = new Date(); 
                        localStorage.setItem(STORAGE_KEYS.RATE, exchangeRate);
                        localStorage.setItem(STORAGE_KEYS.TIMESTAMP, lastFetchedTime.toISOString());
                        updateRateDisplay(false); 
                    } else {
                        throw new Error('Could not find INR rate in API response.');
                    }
                } catch (error) {
                    console.error('Error fetching exchange rate:', error);
                    if (exchangeRate) {
                        // If fetch fails but we have an old rate, show it
                        updateRateDisplay(true); 
                    } else {
                        // If no rate at all
                        rateDisplay.innerHTML = `<span class="text-red-400">Could not load rate.</span>`;
                        updateStatus.textContent = 'Please check connection and try again.';
                    }
                }
            }

            // --- Conversion Functions ---

            function convertAedToInr() {
                if (!exchangeRate || !isAedToInr) return;
                const aedValue = parseFloat(aedInput.value);
                if (isNaN(aedValue) || aedValue === 0) {
                    inrInput.value = '';
                    return;
                }
                const inrValue = aedValue * exchangeRate;
                inrInput.value = showDecimals ? inrValue.toFixed(2) : Math.ceil(inrValue);
            }

            function convertInrToAed() {
                if (!exchangeRate || isAedToInr) return;
                const inrValue = parseFloat(inrInput.value);
                if (isNaN(inrValue) || inrValue === 0) {
                    aedInput.value = '';
                    return;
                }
                const aedValue = inrValue / exchangeRate;
                aedInput.value = aedValue.toFixed(2);
            }

            // --- Event Listeners ---

            aedInput.addEventListener('focus', () => { 
                isAedToInr = true; 
                activeInput = aedInput; // Set active input
            });
            inrInput.addEventListener('focus', () => { 
                isAedToInr = false; 
                activeInput = inrInput; // Set active input
            });
            
            // Remove direct input listeners, as we now use the keypad
            // aedInput.addEventListener('input', convertAedToInr);
            // inrInput.addEventListener('input', convertInrToAed);

            aedInput.addEventListener('blur', addHistoryItem);
            inrInput.addEventListener('blur', addHistoryItem);

            clearButton.addEventListener('click', () => {
                aedInput.value = '';
                inrInput.value = '';
            });

            clearHistoryButton.addEventListener('click', clearHistory);

            decimalToggleButton.addEventListener('click', () => {
                showDecimals = !showDecimals; 
                if (showDecimals) {
                    decimalToggleButton.classList.remove('text-gray-500', 'hover:text-cyan-400');
                    decimalToggleButton.classList.add('text-cyan-400', 'hover:text-cyan-300');
                    decimalToggleButton.title = "Switch to no decimals (round up)";
                } else {
                    decimalToggleButton.classList.remove('text-cyan-400', 'hover:text-cyan-300');
                    decimalToggleButton.classList.add('text-gray-500', 'hover:text-cyan-400');
                    decimalToggleButton.title = "Switch to two decimals";
                }
                if (aedInput.value) {
                    isAedToInr = true; 
                    convertAedToInr();
                }
            });

            // NEW: Event listener for the refresh button
            getRatesButton.addEventListener('click', () => {
                // Show immediate feedback that it's working
                rateDisplay.innerHTML = `
                    <div class="spinner"></div>
                    <span>Fetching live rate...</span>
                `;
                // Call the existing fetch function
                fetchExchangeRate();
            });

            // --- Keypad Logic ---
            keypad.addEventListener('click', (e) => {
                const key = e.target.closest('.keypad-button');
                if (!key || !activeInput) return; // Do nothing if no key or no active input

                const keyValue = key.dataset.key;

                if (keyValue === 'backspace') {
                    // Handle backspace
                    activeInput.value = activeInput.value.slice(0, -1);
                } else if (keyValue === '.') {
                    // Handle decimal, only add if one doesn't exist
                    if (!activeInput.value.includes('.')) {
                        activeInput.value += keyValue;
                    }
                } else {
                    // Handle number
                    activeInput.value += keyValue;
                }

                // Manually trigger the correct conversion
                if (activeInput === aedInput) {
                    convertAedToInr();
                } else {
                    convertInrToAed();
                }
            });

            // Add visual press effect for keypad buttons
            keypad.addEventListener('mousedown', (e) => {
                const key = e.target.closest('.keypad-button');
                if (key) key.classList.add('key-active');
            });
            keypad.addEventListener('mouseup', (e) => {
                const key = e.target.closest('.keypad-button');
                if (key) key.classList.remove('key-active');
            });
            // Handle leaving the button while pressed
            keypad.addEventListener('mouseleave', (e) => {
                 e.target.closest('.keypad-button')?.classList.remove('key-active');
            }, true);


            // --- Initial Load ---
            const cacheLoaded = loadFromCache();     // Load cached rate instantly
            loadHistory();       // Load saved history
            
            // If cache was empty, fetch a rate. Otherwise, wait for user.
            if (!cacheLoaded) {
                fetchExchangeRate(); // Try to get fresh data only if cache is empty
            }

            // Add an interval to update the relative time every minute
            setInterval(() => {
                if (lastFetchedTime) {
                    updateRateDisplay(!navigator.onLine);
                }
            }, 60000); // 1 minute

            // Render all Lucide icons
            lucide.createIcons();

            // --- Set AED as default active input ---
            activeInput = aedInput;
            // Programmatically focus for visual feedback (ring)
            // 'preventScroll' is good practice, though not essential here.
            aedInput.focus({ preventScroll: true });
        });
    </script>

</body>
</html>
